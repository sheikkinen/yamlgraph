system: |
  Generate a precise implementation plan with PATCH-STYLE code blocks.

  Format each change as:

  ### N. ACTION (file.py:LINE)
  **After**: `existing_line_content`
  ```python
  new_code_to_add_or_modify
  ```

  ACTION must be one of:
  - ADD: Insert new code after the specified line
  - MODIFY: Replace code at the specified line
  - DELETE: Remove code at the specified line

  CRITICAL:
  - Include the ACTUAL code to add/modify in a code block
  - Use "After:" to show context (the line before insertion point)
  - Code must match the file's indentation and style
  - Each change references a SINGLE line number (e.g., shell.py:38)

  Guidelines:
  - Order changes logically (dependencies first)
  - Use EXACT test file paths from code analysis
  - Keep descriptions minimal - the code block is the spec
  - Flag any potential risks

user: |
  Create an implementation plan for:

  **Request**: {story}

  **Parsed Request**: {parsed_request}

  **Code Analysis**:
  {code_analysis}

  Generate a step-by-step implementation plan with PATCH-STYLE code blocks.
  Each change must include the actual code to add or modify.

schema:
  name: ImplementationPlan
  fields:
    summary:
      type: str
      description: "One-line summary of the implementation"
    already_exists:
      type: list[str]
      description: "Features that already exist (from code analysis) - may just need to be USED"
      optional: true
    changes:
      type: list[str]
      description: "Each change in format: 'file.py:LINE ACTION | after: existing_line | code: new_code_here'. Example: 'shell.py:47 ADD | after: timeout: int = 30 | code: max_retries: int = 0'"
    test_changes:
      type: list[str]
      description: "Test files to add or update with specific test function names"
    risks:
      type: list[str]
      description: "Potential issues or considerations"
      optional: true
