# Multi-Turn NPC Encounter with Human-in-the-Loop
#
# This graph runs a turn-by-turn encounter where the DM provides input each round.
# Uses interrupt nodes to pause for DM narration.
#
# Usage:
#   python examples/npc/run_encounter.py
#
# Or programmatically:
#   1. Create NPCs with npc-creation.yaml
#   2. Run this graph with NPC data as input
#   3. Loop: invoke â†’ interrupt â†’ user input â†’ resume
#
version: "1.0"
name: encounter-loop
description: Multi-turn NPC encounter with DM interrupts

checkpointer:
  type: sqlite
  path: ":memory:"

defaults:
  provider: anthropic
  temperature: 0.7

# Python tools for image generation
tools:
  generate_scene_image:
    type: python
    module: examples.npc.nodes.image_node
    function: generate_scene_image_node
    description: Generate an image of the current scene using Replicate API

state:
  # NPC data (JSON string or dict)
  npc_name: str
  npc_appearance: str
  npc_voice: str
  npc_personality: str
  npc_behavior: str
  npc_goals: str

  # Location context
  location: str
  location_description: str

  # Turn state
  turn_number: int
  dm_input: str
  encounter_history: list

  # Turn outputs
  perception: dict
  decision: dict
  narration: str
  turn_summary: str
  scene_prompt: str
  scene_image: str

nodes:
  # Wait for DM input
  await_dm:
    type: interrupt
    message: |
      ðŸŽ² Turn {state.turn_number} - What happens next?
      (Type 'end' to finish the encounter)
    resume_key: dm_input

  # NPC perceives the situation
  perceive:
    type: llm
    prompt: examples/npc/encounter_perceive
    state_key: perception
    temperature: 0.5
    skip_if_exists: false
    variables:
      npc_name: "{state.npc_name}"
      npc_personality: "{state.npc_personality}"
      npc_goals: "{state.npc_goals}"
      location: "{state.location}"
      recent_events: "{state.dm_input}"
      other_npcs: ""

  # NPC decides what to do
  decide:
    type: llm
    prompt: examples/npc/encounter_decide
    state_key: decision
    temperature: 0.7
    skip_if_exists: false
    variables:
      npc_name: "{state.npc_name}"
      npc_voice: "{state.npc_voice}"
      npc_personality: "{state.npc_personality}"
      npc_behavior: "{state.npc_behavior}"
      perception: "{state.perception}"
      encounter_type: "social"

  # Generate narration
  narrate:
    type: llm
    prompt: examples/npc/encounter_narrate
    state_key: narration
    temperature: 0.8
    skip_if_exists: false
    variables:
      npc_name: "{state.npc_name}"
      npc_appearance: "{state.npc_appearance}"
      location: "{state.location}"
      decision: "{state.decision}"

  # Generate image prompt from narration
  describe_scene:
    type: llm
    prompt: examples/npc/scene_describe
    state_key: scene_prompt
    temperature: 0.6
    skip_if_exists: false
    variables:
      location: "{state.location}"
      location_description: "{state.location_description}"
      narration: "{state.narration}"
      npcs: []

  # Generate scene image
  generate_scene_image:
    type: python
    tool: generate_scene_image
    state_key: scene_image

  # Summarize the turn for history
  summarize:
    type: llm
    prompt: examples/npc/encounter_summarize
    state_key: turn_summary
    temperature: 0.5
    skip_if_exists: false
    variables:
      turn_number: "{state.turn_number}"
      location: "{state.location}"
      location_description: "{state.location_description}"
      dm_input: "{state.dm_input}"
      actions:
        - npc_name: "{state.npc_name}"
          action_type: "{state.decision.action_type}"
          description: "{state.decision.action_description}"
          dialogue: "{state.decision.dialogue}"

  # Increment turn counter and append to history
  next_turn:
    type: passthrough
    output:
      turn_number: "{state.turn_number + 1}"
      encounter_history: "{state.encounter_history + [state.turn_summary]}"

edges:
  - from: START
    to: await_dm

  # Check if user wants to end
  - from: await_dm
    to: END
    condition: "dm_input == 'end'"

  # Otherwise process the turn
  - from: await_dm
    to: perceive
    condition: "dm_input != 'end'"

  - from: perceive
    to: decide

  - from: decide
    to: narrate

  - from: narrate
    to: describe_scene

  - from: describe_scene
    to: generate_scene_image

  - from: generate_scene_image
    to: summarize

  - from: summarize
    to: next_turn

  # Loop back to await next DM input
  - from: next_turn
    to: await_dm
